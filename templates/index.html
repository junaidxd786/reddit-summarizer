<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reddit Thread Summarizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', Arial, sans-serif; background: #f6f7f8; }
        .container-custom { max-width: 700px; margin: 40px auto; background: #fff; padding: 2em 1.5em; border-radius: 16px; box-shadow: 0 4px 24px #0002; }
        h1 { text-align: center; font-size: 2.2em; font-weight: 700; letter-spacing: 1px; margin-bottom: 1.2em; }
        .error { color: #b00; margin-top: 1em; text-align: center; font-weight: 500; }
        
        /* Dark theme styles */
        body.dark-theme {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.dark-theme .container-custom {
            background: #2d2d2d;
            box-shadow: 0 4px 24px #0004;
        }
        
        body.dark-theme .form-control,
        body.dark-theme .form-select {
            background: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }
        
        body.dark-theme .form-control:focus,
        body.dark-theme .form-select:focus {
            background: #3a3a3a;
            border-color: #0079d3;
            color: #e0e0e0;
        }
        
        body.dark-theme .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.dark-theme .list-group-item {
            background: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }
        
        @media (max-width: 800px) {
            .container-custom { max-width: 100vw; padding: 1em 0.2em; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">Reddit Thread Summarizer</a>
        <div class="d-flex align-items-center">
          <button class="btn btn-outline-light btn-sm me-2" onclick="toggleTheme()" id="themeToggle">
            <span id="themeIcon">🌙</span>
          </button>
        </div>
      </div>
    </nav>
    <div class="container container-custom mt-5">
        <h1 class="text-center mb-4">Reddit Thread Summarizer</h1>
        <form method="post">
            <div class="mb-3">
                <input type="url" id="thread_url" name="thread_url" class="form-control" placeholder="https://www.reddit.com/r/..." value="{{ thread_url_val }}">
            </div>
            <div class="mb-3 row align-items-center">
                <label for="summary_length" class="col-sm-4 col-form-label">Summary Length:</label>
                <div class="col-sm-8">
                    <select id="summary_length" name="summary_length" class="form-select">
                        <option value="short" {% if summary_length_val == 'short' %}selected{% endif %}>Short</option>
                        <option value="medium" {% if summary_length_val == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="detailed" {% if summary_length_val == 'detailed' %}selected{% endif %}>Detailed</option>
                    </select>
                </div>
            </div>
            <div class="d-flex flex-column flex-md-row gap-2 mb-3">
                <button type="submit" class="btn btn-primary flex-fill">Summarize</button>
                <button type="button" id="surprise-btn" class="btn btn-outline-secondary flex-fill">Random Thread</button>
            </div>
            <div class="text-center mb-3">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#trendingModal">Trending Threads</button>
            </div>
        </form>
        {% if error %}<div class="alert alert-danger mt-3">{{ error }}</div>{% endif %}

        <!-- Trending Threads Modal -->
        <div class="modal fade" id="trendingModal" tabindex="-1" aria-labelledby="trendingModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="trendingModalLabel">Trending Reddit Threads</h5>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshTrendingThreads()">Refresh</button>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
              </div>
              <div class="modal-body" id="trendingModalBody">
                {% if trending_threads %}
                <ul class="list-group">
                  {% for thread in trending_threads %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="thread-title" style="flex:1; cursor:pointer; color:#0079d3; text-decoration:underline;" onclick="useTrendingThread('{{ thread.url }}')">{{ thread.title }}</span>
                    <a href="{{ thread.url }}" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">View</a>
                  </li>
                  {% endfor %}
                </ul>
                <div class="form-text mt-2">Click a thread title to summarize it instantly.</div>
                {% else %}
                <div class="text-muted">No trending threads found.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Theme switcher
    function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('themeIcon');
        
        if (body.classList.contains('dark-theme')) {
            body.classList.remove('dark-theme');
            themeIcon.textContent = '🌙';
            localStorage.setItem('theme', 'light');
        } else {
            body.classList.add('dark-theme');
            themeIcon.textContent = '☀️';
            localStorage.setItem('theme', 'dark');
        }
    }
    
    // Load saved theme
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('themeIcon').textContent = '☀️';
        }
    });
    
    document.getElementById('surprise-btn').onclick = function() {
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Loading...';
        fetch('/random_thread_url')
            .then(r => r.json())
            .then(data => {
                if (data.url) {
                    document.getElementById('thread_url').value = data.url;
                    btn.textContent = 'Random Thread';
                    btn.disabled = false;
                    document.querySelector('form').submit(); 
                } else {
                    btn.textContent = 'Random Thread';
                    btn.disabled = false;
                    alert('Could not fetch a trending Reddit thread. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error fetching random thread:', error);
                btn.textContent = 'Random Thread';
                btn.disabled = false;
                alert('Could not fetch a trending Reddit thread. Please try again.');
            });
    };
    function useTrendingThread(url) {
        document.getElementById('thread_url').value = url;
        document.querySelector('form').submit();
    }
    
    function refreshTrendingThreads() {
        const modalBody = document.getElementById('trendingModalBody');
        const refreshBtn = document.querySelector('[onclick="refreshTrendingThreads()"]');
        
        // Show loading state
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Loading trending threads...</p></div>';
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Refreshing...';
        
        // First check circuit breaker status
        fetch('/status')
            .then(response => response.json())
            .then(status => {
                console.log('Circuit breaker status:', status);
                if (status.reddit_circuit_breaker.state === 'OPEN') {
                    throw new Error('Reddit API is temporarily unavailable due to rate limits or service issues. Please try again in a few minutes.');
                }
                return fetch('/trending_threads');
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Trending threads data:', data);
                if (data.threads && data.threads.length > 0) {
                    let html = '<ul class="list-group">';
                    data.threads.forEach(thread => {
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="thread-title" style="flex:1; cursor:pointer; color:#0079d3; text-decoration:underline;" onclick="useTrendingThread('${thread.url}')">${thread.title}</span>
                            <a href="${thread.url}" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">View</a>
                        </li>`;
                    });
                    html += '</ul><div class="form-text mt-2">Click a thread title to summarize it instantly.</div>';
                    modalBody.innerHTML = html;
                } else {
                    modalBody.innerHTML = '<div class="text-muted">No trending threads found.</div>';
                }
            })
            .catch(error => {
                console.error('Error fetching trending threads:', error);
                modalBody.innerHTML = `<div class="text-danger">Error loading trending threads: ${error.message}. Please try again.</div>`;
            })
            .finally(() => {
                // Reset button state
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'Refresh';
            });
    }
    </script>
</body>
</html>